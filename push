#!/bin/bash
# åšå®¢æ¨é€è„šæœ¬ - è‡ªåŠ¨æ„å»ºå¹¶å¼ºåˆ¶æ¨é€è‡³è¿œç¨‹ä»“åº“

# è·å–é¡¹ç›®æ ¹ç›®å½•
PROJECT_DIR="/home/tetsuya/project/blog.iamcheyan.com"
cd "$PROJECT_DIR" || exit 1

echo "ğŸš€ Starting Blog Push Process..."
echo "Date: $(date)"

# 1. ç¡®ä¿ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒä¸­çš„ Python å’Œ Pelican
VENV_PYTHON="$PROJECT_DIR/.venv/bin/python"
if [ ! -f "$VENV_PYTHON" ]; then
    VENV_PYTHON="$PROJECT_DIR/venv/bin/python"
fi

if [ ! -f "$VENV_PYTHON" ]; then
    echo "âŒ Virtual environment not found!"
    exit 1
fi

# 2. æ„å»ºç”Ÿäº§ç‰ˆæœ¬
echo "ğŸ¨ Building production site..."
$VENV_PYTHON -m pelican content -s publishconf.py

if [ $? -ne 0 ]; then
    echo "âŒ Build failed!"
    exit 1
fi

# 3. Git æ“ä½œ
echo "ğŸ“¤ Pushing to GitHub..."

# æ·»åŠ æ‰€æœ‰å˜æ›´
git add .

# æäº¤ï¼ˆå¦‚æœæ²¡å˜åŒ–åˆ™è·³è¿‡ï¼Œä½†é€šå¸¸æ„å»ºåä¼šæœ‰å˜åŒ–ï¼‰
COMMIT_MSG="Auto update: $(date '+%Y-%m-%d %H:%M')"
git commit -m "$COMMIT_MSG" || echo "âš ï¸ No changes to commit."

# å¼ºåˆ¶æ¨é€
git push origin master --force

if [ $? -eq 0 ]; then
    echo "âœ… Successfully pushed to GitHub!"
else
    echo "âŒ Push failed!"
    exit 1
fi

echo "ğŸ‰ Blog update complete!"
