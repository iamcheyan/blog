<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Content Management Tool</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header>
    <div class="left">Content Management Tool</div>
    <div class="right">
      <input id="search-input" type="search" placeholder="Search (Enter)" />
      <button id="btn-new">New</button>
      <button id="btn-push">Push</button>
    </div>
  </header>
  <main>
    <aside class="sidebar">
      <div class="tree" id="tree"></div>
    </aside>
    <section class="content">
      <div class="toolbar">
        <button id="btn-save">Save</button>
        <button id="btn-rename">Rename</button>
        <button id="btn-delete">Delete</button>
        <span class="file-path" id="file-path"></span>
      </div>
      <textarea id="editor"></textarea>
    </section>
  </main>

  <!-- Toast ÂÆπÂô® -->
  <div id="toast-container"></div>
  <!-- Terminal Overlay -->
  <div id="terminal" class="terminal-overlay">
    <div class="terminal-box">
      <div class="terminal-header">
        <div class="terminal-title">Git Push</div>
        <button id="terminal-close" class="terminal-close">Close</button>
      </div>
      <pre id="terminal-body" class="terminal-body"></pre>
    </div>
  </div>
  <!-- Search Modal -->
  <div id="search-modal" class="terminal-overlay">
    <div class="terminal-box">
      <div class="terminal-header">
        <div class="terminal-title">Search</div>
        <button id="search-close" class="terminal-close">Close</button>
      </div>
      <div class="terminal-body">
        <ul id="search-results" class="search-list"></ul>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
  <script>
    const treeEl = document.getElementById('tree');
    const filePathEl = document.getElementById('file-path');
    const btnSave = document.getElementById('btn-save');
    const btnRename = document.getElementById('btn-rename');
    const btnDelete = document.getElementById('btn-delete');
    const btnNew = document.getElementById('btn-new');
    const btnPush = document.getElementById('btn-push');
    const terminalEl = document.getElementById('terminal');
    const terminalBody = document.getElementById('terminal-body');
    const terminalClose = document.getElementById('terminal-close');
    const searchInput = document.getElementById('search-input');
    const searchModal = document.getElementById('search-modal');
    const searchClose = document.getElementById('search-close');
    const searchResults = document.getElementById('search-results');
    const LAST_OPEN_KEY = 'cm_last_open_path';
    let currentPath = '';
    const editor = new EasyMDE({
      element: document.getElementById('editor'),
      spellChecker: false,
      autofocus: true,
      autosave: { enabled: false },
      renderingConfig: { singleLineBreaks: false, codeSyntaxHighlighting: true },
      previewRender: (plainText) => {
        // ÊèêÂèñÂπ∂Ê∏≤Êüì YAML Front Matter
        const fmMatch = plainText.match(/^---\s*\n([\s\S]*?)\n---\s*\n?/);
        let fm = '';
        let body = plainText;
        if (fmMatch) {
          fm = fmMatch[1];
          body = plainText.slice(fmMatch[0].length);
        }
        function escapeHtml(str) {
          return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        }
        const fmHtml = fm
          ? `<div class="fm-box"><div class="fm-title">Front Matter</div><pre>${escapeHtml(fm)}</pre></div>`
          : '';
        return fmHtml + editor.markdown(body);
      },
        // Á¶ÅÊ≠¢Âπ∂ÊéíÈ¢ÑËßàÊó∂Ëá™Âä®ËøõÂÖ•ÂÖ®Â±è
        sideBySideFullscreen: false,
      minHeight: 'calc(100vh - 120px)'
    });

    // ‰∏∫ÁºñËæëÂô®ÂÜÖÁöÑ YAML Front Matter Ê∑ªÂä†Ë°åÊ†∑Âºè
    const cm = editor.codemirror;
    const containerEl = document.querySelector('.EasyMDEContainer');

    // ÁßªÈô§È¢ÑËßàËÆ∞ÂøÜÈÄªËæëÔºå‰ªÖ‰øùÁïôÂπ∂ÊéíÂº∫Âà∂ÂºÄÂêØÂ∑•ÂÖ∑
    function isSideActive() {
      return containerEl.classList.contains('side-by-side') || !!containerEl.querySelector('.editor-preview-active-side');
    }

    function ensureSideBySideOn() {
      // Âº∫Âà∂Âπ∂ÊéíÔºà‰ºöËá™Âä®Â§ÑÁêÜÈ¢ÑËßà‰æßËæπÔºâ
      if (!isSideActive()) editor.toggleSideBySide();
    }

    // ÂàùÊ¨°Âä†ËΩΩÁ°Æ‰øùÂπ∂ÊéíÂºÄÂêØ
    setTimeout(() => { ensureSideBySideOn(); }, 0);
    let fmRange = { start: -1, end: -1 };
    function markFrontMatter() {
      // Ê∏ÖÈô§ÊóßÊ†∑Âºè
      if (fmRange.start !== -1) {
        for (let i = fmRange.start; i <= fmRange.end; i++) {
          cm.removeLineClass(i, 'wrap', 'cm-front-matter');
        }
        fmRange = { start: -1, end: -1 };
      }
      const line0 = cm.getLine(0) || '';
      if (line0.trim() !== '---') return;
      const total = cm.lineCount();
      let end = -1;
      for (let i = 1; i < Math.min(total, 500); i++) {
        if ((cm.getLine(i) || '').trim() === '---') { end = i; break; }
      }
      if (end >= 0) {
        for (let i = 0; i <= end; i++) {
          cm.addLineClass(i, 'wrap', 'cm-front-matter');
        }
        fmRange = { start: 0, end };
      }
    }
    cm.on('change', () => { setTimeout(markFrontMatter, 50); });

    function toast(message, type = 'info', duration = 2600) {
      const container = document.getElementById('toast-container');
      const item = document.createElement('div');
      item.className = `toast-item ${type}`;
      item.innerHTML = `<div>${message}</div><span class="toast-close">√ó</span>`;
      container.appendChild(item);
      requestAnimationFrame(() => item.classList.add('show'));
      const remove = () => { item.classList.remove('show'); setTimeout(() => item.remove(), 200); };
      const timer = setTimeout(remove, duration);
      item.querySelector('.toast-close').onclick = () => { clearTimeout(timer); remove(); };
    }

    async function api(path, options) {
      try {
        const res = await fetch(path, options);
        if (!res.ok) throw new Error(await res.text());
        return await res.json();
      } catch (e) {
        toast(e?.message || 'ËØ∑Ê±ÇÂ§±Ë¥•', 'error');
        throw e;
      }
    }

    function renderTree(node) {
      const ul = document.createElement('ul');
      if (!node.children) return ul;
      for (const child of node.children) {
        const li = document.createElement('li');
        if (child.type === 'directory') {
          // ÁõÆÂΩïÂêçÁß∞
          const isYear = /^\d{4}$/.test(child.name);
          const header = document.createElement('span');
          header.className = 'dir';
          header.innerHTML = `üìÅ <span class="folder">${child.name}</span>`;
          li.appendChild(header);
          if (isYear) {
            const actions = document.createElement('span');
            actions.className = 'year-actions';
            const btn = document.createElement('button');
            btn.className = 'btn-year-new';
            btn.textContent = 'New';
            btn.title = `Âú® ${child.name} Âπ¥Êñ∞Â¢û Markdown`;
            btn.onclick = async (e) => {
              e.stopPropagation();
              const title = prompt('ËØ∑ËæìÂÖ•ÊñáÁ´†Ê†áÈ¢òÔºàÂèØÁïôÁ©∫Ôºâ', '');
              const res = await api('/api/new', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, tags: '', summary: '', year: Number(child.name) })
              });
              await loadTree();
              if (res.path) openFile(res.path);
              toast(`Â∑≤Âú® ${child.name} ÂàõÂª∫Êñ∞ÊñáÁ´†`, 'success');
            };
            actions.appendChild(btn);
            li.appendChild(actions);
          }
          li.appendChild(renderTree(child));
        } else {
          const a = document.createElement('a');
          a.className = 'file';
          a.dataset.path = child.path;
          a.onclick = () => openFile(child.path);
          const meta = child.datetime ? `<span class="meta">${formatMetaDate(child.datetime)}</span>` : '';
          a.innerHTML = `üìù ${child.name}${meta}`;
          li.appendChild(a);
        }
        ul.appendChild(li);
      }
      return ul;
    }

    function formatMetaDate(dt) {
      // ËæìÂÖ•ÂèØËÉΩ‰∏∫ "YYYY-MM-DD HH:MM" ÊàñÂÖ∂ÂÆÉÔºõÂ¶ÇÊûú HH:MM ‰∏∫ 00:00 ÂàôÂè™ÊòæÁ§∫Êó•Êúü
      try {
        const m = dt.match(/^(\d{4}-\d{2}-\d{2})(?:\s+(\d{2}:\d{2}))?$/);
        if (m) {
          const date = m[1];
          const time = m[2];
          if (!time || time === '00:00') return date;
          return `${date} ${time}`;
        }
        return dt;
      } catch (e) {
        return dt;
      }
    }

    async function loadTree() {
      const data = await api('/api/tree');
      treeEl.innerHTML = '';
      treeEl.appendChild(renderTree(data));
      highlightCurrent();
    }

    async function openFile(path) {
      const { content } = await api(`/api/file?path=${encodeURIComponent(path)}`);
      currentPath = path;
      filePathEl.textContent = path;
      editor.value(content);
      // ËÆ∞‰ΩèÊúÄËøëÊâìÂºÄ
      try { localStorage.setItem(LAST_OPEN_KEY, path); } catch (e) {}
      highlightCurrent();
      // ÂàáÊç¢Êñá‰ª∂ÂêéÂêåÊ≠• front matter È´ò‰∫Æ
      setTimeout(() => {
        try { editor.codemirror && editor.codemirror.refresh(); } catch (e) {}
        try { editor.codemirror && editor.codemirror.execCommand('goDocStart'); } catch (e) {}
        try { editor.codemirror && editor.codemirror.focus(); } catch (e) {}
        if (typeof markFrontMatter === 'function') markFrontMatter();
        // Á°Æ‰øùÂπ∂ÊéíÂºÄÂêØ
        ensureSideBySideOn();
      }, 0);
    }

    function highlightCurrent() {
      const items = treeEl.querySelectorAll('a.file');
      items.forEach(a => {
        if (a.dataset.path === currentPath) a.classList.add('active');
        else a.classList.remove('active');
      });
    }

    // ÊêúÁ¥¢ÂäüËÉΩ
    function openSearch() { searchModal.style.display = 'flex'; }
    function closeSearch() { searchModal.style.display = 'none'; }
    searchClose.onclick = closeSearch;
    function renderSearchResults(list) {
      searchResults.innerHTML = '';
      if (!list || list.length === 0) {
        const li = document.createElement('li');
        li.className = 'search-item';
        li.textContent = 'No results';
        searchResults.appendChild(li);
        return;
      }
      for (const item of list) {
        const li = document.createElement('li');
        li.className = 'search-item';
        li.innerHTML = `<div class="title">${item.title}</div>
                        <div class="path">${item.path}</div>
                        <div class="snippet">${(item.snippet||'').replace(/[<>]/g, '')}</div>`;
        li.onclick = () => { closeSearch(); openFile(item.path); };
        searchResults.appendChild(li);
      }
    }
    async function doSearch(q) {
      if (!q) return;
      openSearch();
      renderSearchResults([{ title: 'Searching...', path: '', snippet: '' }]);
      try {
        const res = await api('/api/search', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ q }) });
        renderSearchResults(res.results || []);
      } catch (e) {
        renderSearchResults([]);
      }
    }
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        doSearch(searchInput.value.trim());
      }
    });
    // Âø´Êç∑ÈîÆ: Ctrl/Cmd+K ËÅöÁÑ¶ÊêúÁ¥¢
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && (e.key.toLowerCase() === 'k')) {
        e.preventDefault();
        searchInput.focus();
      }
      if (e.key === 'Escape') {
        closeSearch();
      }
    });

    btnSave.onclick = async () => {
      if (!currentPath) { toast('ËØ∑ÂÖàÂú®Â∑¶‰æßÈÄâÊã©Ë¶ÅÁºñËæëÁöÑ Markdown Êñá‰ª∂', 'error'); return; }
      const content = editor.value();
      await api('/api/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: currentPath, content })
      });
      toast('Â∑≤‰øùÂ≠ò', 'success');
    };

    btnNew.onclick = async () => {
      const title = prompt('ËØ∑ËæìÂÖ•ÊñáÁ´†Ê†áÈ¢ò');
      if (title === null) return;
      const tags = prompt('ËØ∑ËæìÂÖ•Ê†áÁ≠æÔºàÁî®ÈÄóÂè∑ÂàÜÈöîÔºâ', '');
      const summary = prompt('ËØ∑ËæìÂÖ•ÊëòË¶Å', '');
      const res = await api('/api/new', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, tags, summary })
      });
      await loadTree();
      if (res.path) openFile(res.path);
      toast('Â∑≤ÂàõÂª∫Êñ∞ÊñáÁ´†', 'success');
    };

    // Push ÂäüËÉΩ
    function openTerminal() { terminalEl.style.display = 'flex'; }
    function closeTerminal() { terminalEl.style.display = 'none'; }
    terminalClose.onclick = closeTerminal;
    btnPush.onclick = async () => {
      openTerminal();
      btnPush.disabled = true;
      terminalBody.textContent = '$ git add -A && git commit && git push\n\nRunning...\n';
      try {
        const res = await api('/api/push', { method: 'POST' });
        terminalBody.textContent = res.log || '';
        toast(res.ok ? 'Push ÂÆåÊàê' : 'Push Â§±Ë¥•', res.ok ? 'success' : 'error');
        // ÊàêÂäüÂêé 3 ÁßíËá™Âä®ÂÖ≥Èó≠
        if (res.ok) setTimeout(() => { closeTerminal(); }, 3000);
      } catch (e) {
        // ÈîôËØØÂ∑≤Âú® api ÂÜÖÈÉ® toast
      } finally {
        btnPush.disabled = false;
      }
    };

    // Á≤òË¥¥ÂõæÁâá‰∏ä‰º† -> Ëá™Âä®ÊèíÂÖ• Markdown
    async function uploadImage(file, year) {
      const fd = new FormData();
      fd.append('image', file, file.name || 'paste.png');
      if (year) fd.append('year', String(year));
      const res = await fetch('/api/upload_image', { method: 'POST', body: fd });
      if (!res.ok) { throw new Error(await res.text()); }
      return res.json();
    }

    function getYearForCurrentFile() {
      // ‰ªéÂΩìÂâçË∑ØÂæÑÊèêÂèñÂπ¥‰ªΩÔºåÂ¶Ç content/2025/xxx.md
      if (!currentPath) return new Date().getFullYear();
      const m = currentPath.match(/^content\/(\d{4})\//);
      return m ? Number(m[1]) : new Date().getFullYear();
    }

    editor.codemirror.on('paste', async (cm, e) => {
      const dt = e.clipboardData;
      if (!dt || !dt.items) return;
      for (const item of dt.items) {
        if (item.kind === 'file' && item.type.startsWith('image/')) {
          e.preventDefault();
          try {
            const file = item.getAsFile();
            const { url } = await uploadImage(file, getYearForCurrentFile());
            const pos = cm.getCursor();
            const text = `![image](${url})`;
            cm.replaceRange(text, pos);
            toast('ÂõæÁâáÂ∑≤‰∏ä‰º†Âπ∂ÊèíÂÖ•', 'success');
          } catch (err) {
            toast('ÂõæÁâá‰∏ä‰º†Â§±Ë¥•', 'error');
          }
          break;
        }
      }
    });

    // ÊãñÊãΩÂõæÁâáÂà∞ÁºñËæëÂô®‰∏ä‰º†
    const cmWrapper = editor.codemirror.getWrapperElement();
    function isFileDrag(evt) {
      const dt = evt.dataTransfer;
      return dt && (dt.types?.includes?.('Files') || dt.files?.length);
    }
    ;['dragenter','dragover'].forEach(ev => {
      cmWrapper.addEventListener(ev, (e) => {
        if (!isFileDrag(e)) return;
        e.preventDefault();
        e.stopPropagation();
        cmWrapper.closest('.EasyMDEContainer')?.classList.add('drag-hover');
      });
    });
    ;['dragleave','dragend','drop'].forEach(ev => {
      cmWrapper.addEventListener(ev, (e) => {
        cmWrapper.closest('.EasyMDEContainer')?.classList.remove('drag-hover');
      });
    });
    cmWrapper.addEventListener('drop', async (e) => {
      if (!isFileDrag(e)) return;
      e.preventDefault();
      e.stopPropagation();
      const files = Array.from(e.dataTransfer.files || []);
      const year = getYearForCurrentFile();
      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;
        try {
          const { url } = await uploadImage(file, year);
          const cm = editor.codemirror;
          const pos = cm.getCursor();
          cm.replaceRange(`![image](${url})\n`, pos);
          toast('ÂõæÁâáÂ∑≤‰∏ä‰º†Âπ∂ÊèíÂÖ•', 'success');
        } catch (err) {
          toast('ÂõæÁâá‰∏ä‰º†Â§±Ë¥•', 'error');
        }
      }
    });

    // ÈáçÂëΩÂêç
    btnRename.onclick = async () => {
      if (!currentPath) { toast('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÈáçÂëΩÂêçÁöÑÊñá‰ª∂', 'error'); return; }
      const parts = currentPath.split('/');
      const currentName = parts[parts.length - 1];
      const newName = prompt('ËæìÂÖ•Êñ∞ÁöÑÊñá‰ª∂ÂêçÔºàÂê´ .mdÔºâ', currentName);
      if (!newName || newName === currentName) return;
      if (!/\.md$/i.test(newName)) { toast('Êñá‰ª∂ÂêçÈúÄ‰ª• .md ÁªìÂ∞æ', 'error'); return; }
      const res = await api('/api/rename', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: currentPath, new_name: newName })
      });
      if (res.path) {
        currentPath = res.path;
        filePathEl.textContent = res.path;
        await loadTree();
        toast('Â∑≤ÈáçÂëΩÂêç', 'success');
      }
    };

    // Âà†Èô§
    btnDelete.onclick = async () => {
      if (!currentPath) { toast('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÊñá‰ª∂', 'error'); return; }
      const ok = confirm('Á°ÆÂÆöÂà†Èô§ÂΩìÂâçÊñá‰ª∂ÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç');
      if (!ok) return;
      await api('/api/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: currentPath })
      });
      toast('Â∑≤Âà†Èô§', 'success');
      editor.value('');
      filePathEl.textContent = '';
      // Ê∏ÖÈô§ÊúÄËøëÊâìÂºÄ
      try {
        const last = localStorage.getItem(LAST_OPEN_KEY);
        if (last === currentPath) localStorage.removeItem(LAST_OPEN_KEY);
      } catch (e) {}
      currentPath = '';
      await loadTree();
    };

    // Ctrl/Cmd + S Âø´Êç∑ÈîÆ‰øùÂ≠ò
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        btnSave.click();
      }
    });

    // È¶ñÊ¨°Âä†ËΩΩÊ†ëÂπ∂Â∞ùËØïÊâìÂºÄ‰∏äÊ¨°ÁöÑÊñá‰ª∂
    (async () => {
      await loadTree();
      try {
        const last = localStorage.getItem(LAST_OPEN_KEY);
        if (last) openFile(last);
      } catch (e) {}
    })();
  </script>
</body>
</html>


