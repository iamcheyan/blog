<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å†…å®¹ç®¡ç†å·¥å…·</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
  <style>
    html, body { height: 100%; margin: 0; }
    body { display: flex; flex-direction: column; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Arial; }
    header { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; }
    header .left { font-weight: 600; }
    header .right button { padding: 6px 10px; border: 1px solid #d1d5db; background: #111827; color: #fff; border-radius: 6px; cursor: pointer; }
    main { flex: 1; display: flex; min-height: 0; }
    .sidebar { width: 320px; border-right: 1px solid #e5e7eb; overflow: auto; padding: 10px; }
    .content { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .toolbar { padding: 8px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 8px; }
    .toolbar button { padding: 6px 10px; border: 1px solid #d1d5db; background: #fff; border-radius: 6px; cursor: pointer; }
    .file-path { color: #6b7280; font-size: 12px; }
    .tree ul { list-style: none; margin: 0; padding-left: 16px; }
    .tree li { margin: 4px 0; cursor: default; }
    .tree .folder { font-weight: 600; }
    .tree .file { cursor: pointer; color: #1f2937; }
    .tree .file:hover { text-decoration: underline; }
    /* YAML Front Matter é¢„è§ˆæ ·å¼ */
    .EasyMDEContainer .editor-preview .fm-box,
    .EasyMDEContainer .editor-preview-side .fm-box {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-left: 4px solid #9ca3af;
      border-radius: 6px;
      padding: 10px 12px;
      margin: 8px 16px 14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      color: #374151;
    }
    .EasyMDEContainer .editor-preview .fm-box .fm-title,
    .EasyMDEContainer .editor-preview-side .fm-box .fm-title {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 6px;
      letter-spacing: .02em;
      text-transform: uppercase;
    }
    .EasyMDEContainer .editor-preview .fm-box pre,
    .EasyMDEContainer .editor-preview-side .fm-box pre {
      margin: 0;
      background: transparent;
      color: inherit;
      padding: 0;
      white-space: pre-wrap;
    }
    /* å·¦ä¾§ç¼–è¾‘å™¨ï¼ˆCodeMirrorï¼‰å¯è¯»æ€§ä¼˜åŒ– */
    .EasyMDEContainer .CodeMirror {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 14px;
      line-height: 1.7;
      padding: 12px 14px; /* è®©æ–‡æœ¬ä¸è´´è¾¹ */
    }
    .EasyMDEContainer .CodeMirror pre { padding: 0; }
    .EasyMDEContainer .CodeMirror-scroll { overscroll-behavior: contain; }
    .EasyMDEContainer .cm-s-easymde .CodeMirror-line { padding-bottom: 2px; }
    /* Markdown token é…è‰²ï¼ˆåœ¨äº®è‰²ä¸»é¢˜ä¸‹æ›´æŸ”å’Œï¼‰ */
    .cm-s-easymde .cm-header { color: #0f172a; font-weight: 700; }
    .cm-s-easymde .cm-strong { color: #0f172a; font-weight: 700; }
    .cm-s-easymde .cm-em { color: #334155; font-style: italic; }
    .cm-s-easymde .cm-link { color: #2563eb; }
    .cm-s-easymde .cm-url { color: #1d4ed8; }
    .cm-s-easymde .cm-quote { color: #475569; }
    .cm-s-easymde .cm-comment { color: #475569; }
    .cm-s-easymde .cm-image { color: #0e7490; }
    /* æ°´å¹³åˆ†éš”çº¿æ›´é†’ç›® */
    .cm-s-easymde .cm-hr { color: #94a3b8; }
    /* é€‰åŒº/å…‰æ ‡å¯è§æ€§ */
    .EasyMDEContainer .CodeMirror div.CodeMirror-cursor { border-left: 2px solid #111827; }
    .EasyMDEContainer .CodeMirror .CodeMirror-selected { background: rgba(37, 99, 235, .18); }
    /* å¹¶æ’æ—¶å·¦å³å„è‡ªå†…è¾¹è·ä¸€è‡´ */
    .EasyMDEContainer .CodeMirror,
    .EasyMDEContainer .editor-preview-side { box-sizing: border-box; }
    /* ç¼–è¾‘å™¨ä¸­çš„ YAML Front Matter é«˜äº®ï¼ˆé¦–ä¸ª --- åˆ°ä¸‹ä¸€ä¸ª --- ä¹‹é—´ï¼‰ */
    .EasyMDEContainer .CodeMirror .cm-front-matter {
      background: #f9fafb;
      border-left: 4px solid #9ca3af;
      /* å¼ºåˆ¶ä½¿ç”¨æ™®é€šå­—å·ä¸å¸¸è§„å­—é‡ï¼Œé¿å…è¢« Markdown æ ‡é¢˜æ ·å¼æ”¾å¤§ */
      font-size: 14px !important;
      font-weight: 400 !important;
    }
    .EasyMDEContainer .CodeMirror .cm-front-matter * {
      font-size: 14px !important;
      font-weight: 400 !important;
    }
    /* ä»…é¢„è§ˆåŒºåŸŸçš„ Markdown æ’ç‰ˆä¼˜åŒ– */
    .EasyMDEContainer .editor-preview,
    .EasyMDEContainer .editor-preview-side {
      color: #111827; /* gray-900 */
      line-height: 1.75;
      font-size: 16px;
      padding: 16px 18px;
    }
    .EasyMDEContainer .editor-preview h1,
    .EasyMDEContainer .editor-preview-side h1 { font-size: 1.875rem; line-height: 2.25rem; margin: 1.2em 0 .6em; font-weight: 700; }
    .EasyMDEContainer .editor-preview h2,
    .EasyMDEContainer .editor-preview-side h2 { font-size: 1.5rem; line-height: 2rem; margin: 1.1em 0 .55em; font-weight: 700; }
    .EasyMDEContainer .editor-preview h3,
    .EasyMDEContainer .editor-preview-side h3 { font-size: 1.25rem; line-height: 1.875rem; margin: 1em 0 .5em; font-weight: 700; }
    .EasyMDEContainer .editor-preview h4,
    .EasyMDEContainer .editor-preview-side h4 { font-size: 1.125rem; line-height: 1.75rem; margin: .9em 0 .45em; font-weight: 600; }
    .EasyMDEContainer .editor-preview h5,
    .EasyMDEContainer .editor-preview-side h5,
    .EasyMDEContainer .editor-preview h6,
    .EasyMDEContainer .editor-preview-side h6 { font-size: 1rem; line-height: 1.5rem; margin: .8em 0 .4em; font-weight: 600; }
    .EasyMDEContainer .editor-preview p,
    .EasyMDEContainer .editor-preview-side p { margin: .8em 0; }
    .EasyMDEContainer .editor-preview a,
    .EasyMDEContainer .editor-preview-side a { color: #2563eb; text-decoration: none; }
    .EasyMDEContainer .editor-preview a:hover,
    .EasyMDEContainer .editor-preview-side a:hover { text-decoration: underline; }
    .EasyMDEContainer .editor-preview img,
    .EasyMDEContainer .editor-preview-side img { max-width: 100%; height: auto; display: block; margin: 10px 0; border-radius: 4px; }
    .EasyMDEContainer .editor-preview code,
    .EasyMDEContainer .editor-preview-side code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: .9em; }
    .EasyMDEContainer .editor-preview pre,
    .EasyMDEContainer .editor-preview-side pre { background: #0b1220; color: #e5e7eb; padding: 12px 14px; border-radius: 8px; overflow: auto; line-height: 1.6; }
    .EasyMDEContainer .editor-preview pre code,
    .EasyMDEContainer .editor-preview-side pre code { background: transparent; padding: 0; border-radius: 0; color: inherit; }
    .EasyMDEContainer .editor-preview blockquote,
    .EasyMDEContainer .editor-preview-side blockquote { margin: 1em 0; padding: .6em .9em; background: #f9fafb; border-left: 4px solid #d1d5db; color: #374151; border-radius: 4px; }
    .EasyMDEContainer .editor-preview ul,
    .EasyMDEContainer .editor-preview-side ul,
    .EasyMDEContainer .editor-preview ol,
    .EasyMDEContainer .editor-preview-side ol { padding-left: 1.4em; margin: .8em 0; }
    .EasyMDEContainer .editor-preview li + li,
    .EasyMDEContainer .editor-preview-side li + li { margin-top: .25em; }
    .EasyMDEContainer .editor-preview table,
    .EasyMDEContainer .editor-preview-side table { width: 100%; border-collapse: collapse; margin: 1em 0; font-size: 14px; }
    .EasyMDEContainer .editor-preview th,
    .EasyMDEContainer .editor-preview-side th,
    .EasyMDEContainer .editor-preview td,
    .EasyMDEContainer .editor-preview-side td { border: 1px solid #e5e7eb; padding: 8px 10px; }
    .EasyMDEContainer .editor-preview thead th,
    .EasyMDEContainer .editor-preview-side thead th { background: #f3f4f6; font-weight: 600; }
    .EasyMDEContainer .editor-preview hr,
    .EasyMDEContainer .editor-preview-side hr { border: 0; border-top: 1px solid #e5e7eb; margin: 1.2em 0; }
    .EasyMDEContainer .editor-preview kbd,
    .EasyMDEContainer .editor-preview-side kbd { background: #111827; color: #fff; padding: 2px 6px; border-radius: 4px; border: 1px solid #111827; font-size: .8em; }
    .EasyMDEContainer .editor-preview input[type="checkbox"],
    .EasyMDEContainer .editor-preview-side input[type="checkbox"] { margin-right: .5em; }
  </style>
</head>
<body>
  <header>
    <div class="left">å†…å®¹ç®¡ç†å·¥å…·</div>
    <div class="right">
      <button id="btn-new">æ–°å»º</button>
    </div>
  </header>
  <main>
    <aside class="sidebar">
      <div class="tree" id="tree"></div>
    </aside>
    <section class="content">
      <div class="toolbar">
        <button id="btn-save">ä¿å­˜</button>
        <span class="file-path" id="file-path"></span>
      </div>
      <textarea id="editor"></textarea>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
  <script>
    const treeEl = document.getElementById('tree');
    const filePathEl = document.getElementById('file-path');
    const btnSave = document.getElementById('btn-save');
    const btnNew = document.getElementById('btn-new');
    let currentPath = '';
    const editor = new EasyMDE({
      element: document.getElementById('editor'),
      spellChecker: false,
      autofocus: true,
      autosave: { enabled: false },
      renderingConfig: { singleLineBreaks: false, codeSyntaxHighlighting: true },
      previewRender: (plainText) => {
        // æå–å¹¶æ¸²æŸ“ YAML Front Matter
        const fmMatch = plainText.match(/^---\s*\n([\s\S]*?)\n---\s*\n?/);
        let fm = '';
        let body = plainText;
        if (fmMatch) {
          fm = fmMatch[1];
          body = plainText.slice(fmMatch[0].length);
        }
        function escapeHtml(str) {
          return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        }
        const fmHtml = fm
          ? `<div class="fm-box"><div class="fm-title">Front Matter</div><pre>${escapeHtml(fm)}</pre></div>`
          : '';
        return fmHtml + editor.markdown(body);
      },
        // ç¦æ­¢å¹¶æ’é¢„è§ˆæ—¶è‡ªåŠ¨è¿›å…¥å…¨å±
        sideBySideFullscreen: false,
      minHeight: 'calc(100vh - 120px)'
    });

    // ä¸ºç¼–è¾‘å™¨å†…çš„ YAML Front Matter æ·»åŠ è¡Œæ ·å¼
    const cm = editor.codemirror;
    let fmRange = { start: -1, end: -1 };
    function markFrontMatter() {
      // æ¸…é™¤æ—§æ ·å¼
      if (fmRange.start !== -1) {
        for (let i = fmRange.start; i <= fmRange.end; i++) {
          cm.removeLineClass(i, 'wrap', 'cm-front-matter');
        }
        fmRange = { start: -1, end: -1 };
      }
      const line0 = cm.getLine(0) || '';
      if (line0.trim() !== '---') return;
      const total = cm.lineCount();
      let end = -1;
      for (let i = 1; i < Math.min(total, 500); i++) {
        if ((cm.getLine(i) || '').trim() === '---') { end = i; break; }
      }
      if (end >= 0) {
        for (let i = 0; i <= end; i++) {
          cm.addLineClass(i, 'wrap', 'cm-front-matter');
        }
        fmRange = { start: 0, end };
      }
    }
    cm.on('change', () => { setTimeout(markFrontMatter, 50); });

    async function api(path, options) {
      const res = await fetch(path, options);
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function renderTree(node) {
      const ul = document.createElement('ul');
      if (!node.children) return ul;
      for (const child of node.children) {
        const li = document.createElement('li');
        if (child.type === 'directory') {
          li.innerHTML = `ğŸ“ <span class="folder">${child.name}</span>`;
          li.appendChild(renderTree(child));
        } else {
          const a = document.createElement('a');
          a.textContent = 'ğŸ“ ' + child.name;
          a.className = 'file';
          a.onclick = () => openFile(child.path);
          li.appendChild(a);
        }
        ul.appendChild(li);
      }
      return ul;
    }

    async function loadTree() {
      const data = await api('/api/tree');
      treeEl.innerHTML = '';
      treeEl.appendChild(renderTree(data));
    }

    async function openFile(path) {
      const { content } = await api(`/api/file?path=${encodeURIComponent(path)}`);
      currentPath = path;
      filePathEl.textContent = path;
      editor.value(content);
      // åˆ‡æ¢æ–‡ä»¶ååŒæ­¥ front matter é«˜äº®
      setTimeout(() => {
        try { editor.codemirror && editor.codemirror.refresh(); } catch (e) {}
        try { editor.codemirror && editor.codemirror.execCommand('goDocStart'); } catch (e) {}
        try { editor.codemirror && editor.codemirror.focus(); } catch (e) {}
        if (typeof markFrontMatter === 'function') markFrontMatter();
      }, 0);
    }

    btnSave.onclick = async () => {
      if (!currentPath) { alert('è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©è¦ç¼–è¾‘çš„ Markdown æ–‡ä»¶'); return; }
      const content = editor.value();
      await api('/api/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: currentPath, content })
      });
      alert('å·²ä¿å­˜');
    };

    btnNew.onclick = async () => {
      const title = prompt('è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜');
      if (title === null) return;
      const tags = prompt('è¯·è¾“å…¥æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰', '');
      const summary = prompt('è¯·è¾“å…¥æ‘˜è¦', '');
      const res = await api('/api/new', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, tags, summary })
      });
      await loadTree();
      if (res.path) openFile(res.path);
    };

    loadTree();
  </script>
</body>
</html>


