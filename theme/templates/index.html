{% extends "base.html" %}

{%- block content %}
    {#      <h1 class="small-title">{% block index_title %}Tous les articles{% endblock index_title %}</h1>#}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        var templates = document.querySelectorAll('script[type="application/x-template"][id^="post-source-"]');
        for (var i = 0; i < templates.length; i++) {
            var tpl = templates[i];
            var idx = tpl.id.replace('post-source-', '');
            var target = document.getElementById('post-content-' + idx);
            if (!target) continue;
            var html = tpl.textContent || tpl.innerHTML || '';
            var m = html.match(/<img\b[\s\S]*?>/i);
            if (m && m[0]) {
                target.innerHTML = m[0];
                // 若文章只有图片且无其他内容，则隐藏“続きを読む”按钮
                var remain = html.replace(m[0], '');
                // 去掉其他 HTML 标签与空白
                remain = remain.replace(/<[^>]+>/g, '').replace(/&nbsp;/g, ' ').trim();
                if (!remain) {
                    var footer = document.getElementById('post-footer-' + idx);
                    if (footer) footer.style.display = 'none';
                }
            } else {
                // 若无图片，则不显示任何内容
                target.innerHTML = '';
            }
        }
    });
    </script>
    {% for article in articles_page.object_list %}
        <article class="post">
            <header class="post-header">
                <h1>
                    <a rel="bookmark"
                       href="{{ SITEURL }}/{{ article.url }}"
                       title="{{ article.title|striptags }}">
                        {{ article.title }}
                    </a>
                </h1>

            </header>

            <div class="post-content js-first-image" id="post-content-{{ loop.index0 }}">
            </div>
            {% set _html = article._content if article._content is defined else article.content %}
            <script type="application/x-template" id="post-source-{{ loop.index0 }}">{{ _html|safe }}</script>
            <div class="meta">
                {% include "includes/article_meta.html" %}
            </div>
            <div class="post-footer" id="post-footer-{{ loop.index0 }}">
                {% if not article.content_all or not article.content_all() %}
                    <a class="readmore" href="{{ SITEURL }}/{{ article.url }}">Read more</a>
                {% endif %}
            </div>
        </article>
        {% set article = False %}
    {% endfor %}

    {%- if articles_page %}
        <nav id="pagination">
            {%- if articles_page.has_previous() %}
                <a id="first_page" href="{{ SITEURL }}/{{ page_name }}.html">&#60;&#60;</a>
                <a id="prev_page" href="{{ SITEURL }}/
                        {{ page_name }}{{ articles_page.previous_page_number() if articles_page.previous_page_number() != 1 else "" }}.html">&#60;</a>
            {% else %}
                <!-- <span id="first_page" class="a inactive">&#60;&#60;</span>
                     <span id="first_page" class="a inactive">&#60;</span> -->
            {% endif -%}

            {%- for i in range(1,articles_paginator.num_pages + 1) %}
                {%- if articles_page.number - 5 < i < articles_page.number + 5 %}
                    {%- if i == articles_page.number %}
                        <span class="a active">{{ loop.index }}</span>
                    {% else %}
                        <a href="{{ SITEURL }}/{{ page_name }}{{ ( i if i != 1 else "" ) }}.html">{{ loop.index }}</a>
                    {% endif -%}
                {% endif -%}
            {% endfor -%}

            {%- if articles_page.has_next() %}
                <a id="next_page" href="{{ SITEURL }}/{{ page_name }}{{ articles_page.next_page_number() }}.html">&#62;</a>
                <a id="last_page" href="{{ SITEURL }}/{{ page_name }}{{ articles_paginator.num_pages }}.html">&#62;&#62;</a>
            {% else %}
                <!-- <span id="next_page" class="a inactive">&#62;</span>
                     <span id="next_page" class="a inactive">&#62;&#62;</span> -->
            {% endif -%}
        </nav>
    {%- endif %}
{% endblock content -%}
